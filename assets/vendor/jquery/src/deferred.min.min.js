define(["./core","./var/slice","./callbacks"],function(d,c){d.extend({Deferred:function(h){var i=[["resolve","done",d.Callbacks("once memory"),"resolved"],["reject","fail",d.Callbacks("once memory"),"rejected"],["notify","progress",d.Callbacks("memory")]],b="pending",a={state:function(){return b},always:function(){j.done(arguments).fail(arguments);return this},then:function(){var e=arguments;return d.Deferred(function(f){d.each(i,function(m,n){var g=d.isFunction(e[m])&&e[m];j[n[1]](function(){var k=g&&g.apply(this,arguments);if(k&&d.isFunction(k.promise)){k.promise().done(f.resolve).fail(f.reject).progress(f.notify)}else{f[n[0]+"With"](this===a?f.promise():this,g?[k]:arguments)}})});e=null}).promise()},promise:function(e){return e!=null?d.extend(e,a):a}},j={};a.pipe=a.then;d.each(i,function(g,m){var e=m[2],f=m[3];a[m[1]]=e.add;if(f){e.add(function(){b=f},i[g^1][2].disable,i[2][2].lock)}j[m[0]]=function(){j[m[0]+"With"](this===j?a:this,arguments);return this};j[m[0]+"With"]=e.fireWith});a.promise(j);if(h){h.call(j,j)}return j},when:function(p){var r=0,n=c.call(arguments),t=n.length,s=t!==1||(p&&d.isFunction(p.promise))?t:0,a=s===1?p:d.Deferred(),q=function(f,e,g){return function(h){e[f]=this;g[f]=arguments.length>1?c.call(arguments):h;if(g===b){a.notifyWith(e,g)}else{if(!(--s)){a.resolveWith(e,g)}}}},b,o,i;if(t>1){b=new Array(t);o=new Array(t);i=new Array(t);for(;r<t;r++){if(n[r]&&d.isFunction(n[r].promise)){n[r].promise().done(q(r,i,n)).fail(a.reject).progress(q(r,o,b))}else{--s}}}if(!s){a.resolveWith(i,n)}return a.promise()}});return d});