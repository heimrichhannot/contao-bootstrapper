/*
 * Bootstrap Grunt task for parsing Less docstrings
 * http://getbootstrap.com
 * Copyright 2014-2015 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 */
"use strict";var Markdown=require("markdown-it");function markdown2html(b){var a=new Markdown();return a.render(b.trim()).slice(3,-5)}var CUSTOMIZABLE_HEADING=/^[/]{2}={2}(.*)$/;var UNCUSTOMIZABLE_HEADING=/^[/]{2}-{2}(.*)$/;var SUBSECTION_HEADING=/^[/]{2}={3}(.*)$/;var SECTION_DOCSTRING=/^[/]{2}#{2}(.+)$/;var VAR_ASSIGNMENT=/^(@[a-zA-Z0-9_-]+):[ ]*([^ ;][^;]*);[ ]*$/;var VAR_DOCSTRING=/^[/]{2}[*]{2}(.+)$/;function Section(b,a){this.heading=b.trim();this.id=this.heading.replace(/\s+/g,"-").toLowerCase();this.customizable=a;this.docstring=null;this.subsections=[]}Section.prototype.addSubSection=function(a){this.subsections.push(a)};function SubSection(a){this.heading=a.trim();this.id=this.heading.replace(/\s+/g,"-").toLowerCase();this.variables=[]}SubSection.prototype.addVar=function(a){this.variables.push(a)};function VarDocstring(a){this.html=markdown2html(a)}function SectionDocstring(a){this.html=markdown2html(a)}function Variable(b,a){this.name=b;this.defaultValue=a;this.docstring=null}function Tokenizer(a){this._lines=a.split("\n");this._next=undefined}Tokenizer.prototype.unshift=function(a){if(this._next!==undefined){throw new Error("Attempted to unshift twice!")}this._next=a};Tokenizer.prototype._shift=function(){if(this._next!==undefined){var a=this._next;this._next=undefined;return a}if(this._lines.length<=0){return null}var b=this._lines.shift();var c=null;c=SUBSECTION_HEADING.exec(b);if(c!==null){return new SubSection(c[1])}c=CUSTOMIZABLE_HEADING.exec(b);if(c!==null){return new Section(c[1],true)}c=UNCUSTOMIZABLE_HEADING.exec(b);if(c!==null){return new Section(c[1],false)}c=SECTION_DOCSTRING.exec(b);if(c!==null){return new SectionDocstring(c[1])}c=VAR_DOCSTRING.exec(b);if(c!==null){return new VarDocstring(c[1])}var e=b.lastIndexOf("//");var d=e===-1?b:b.slice(0,e);c=VAR_ASSIGNMENT.exec(d);if(c!==null){return new Variable(c[1],c[2])}return undefined};Tokenizer.prototype.shift=function(){while(true){var a=this._shift();if(a===undefined){continue}return a}};function Parser(a){this._tokenizer=new Tokenizer(a)}Parser.prototype.parseFile=function(){var b=[];while(true){var a=this.parseSection();if(a===null){if(this._tokenizer.shift()!==null){throw new Error("Unexpected unparsed section of file remains!")}return b}b.push(a)}};Parser.prototype.parseSection=function(){var b=this._tokenizer.shift();if(b===null){return null}if(!(b instanceof Section)){throw new Error("Expected section heading; got: "+JSON.stringify(b))}var a=this._tokenizer.shift();if(a instanceof SectionDocstring){b.docstring=a}else{this._tokenizer.unshift(a)}this.parseSubSections(b);return b};Parser.prototype.parseSubSections=function(b){while(true){var a=this.parseSubSection();if(a===null){if(b.subsections.length===0){a=new SubSection("");this.parseVars(a)}else{break}}b.addSubSection(a)}if(b.subsections.length===1&&!b.subsections[0].heading&&b.subsections[0].variables.length===0){b.subsections=[]}};Parser.prototype.parseSubSection=function(){var a=this._tokenizer.shift();if(a instanceof SubSection){this.parseVars(a);return a}this._tokenizer.unshift(a);return null};Parser.prototype.parseVars=function(b){while(true){var a=this.parseVar();if(a===null){return}b.addVar(a)}};Parser.prototype.parseVar=function(){var b=this._tokenizer.shift();if(!(b instanceof VarDocstring)){this._tokenizer.unshift(b);b=null}var a=this._tokenizer.shift();if(a instanceof Variable){a.docstring=b;return a}this._tokenizer.unshift(a);return null};module.exports=Parser;